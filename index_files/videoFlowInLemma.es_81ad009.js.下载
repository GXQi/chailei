define("wiki-m-lemma:widget/beforeContent-n/secondTop/videoFlowInLemma.es",["require","exports","module","wiki-m-common:widget/lib/zepto/zepto","wiki-m-common:widget/util/nslog","wiki-m-common:widget/component/share/floatShare","wiki-m-common:widget/util/checkCss","wiki-m-second:widget/videoFlowIn2nd/VideoFlowIn2nd","wiki-m-common:widget/component/baikeAppLetter/letter","wiki-m-common:widget/util/url","wiki-m-second:widget/container/videoCommon/videoCommon","wiki-m-second:widget/component/praise/praise","wiki-m-second:widget/util/guid","wiki-m-common:widget/component/sf/sf","wiki-m-common:widget/component/swan/swanUtil"],function(e,t,i){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function a(){var e=d(".J-invoke-2ndvideoflow"),t=e.length,i=[],o=[],n=[],a={list:{}};a.list["同词条"]=[];for(var r=0;t>r;r++){var l=e.eq(r),s=l.data("url");i[r]=l.find("img").eq(0).attr("src")||"",o[r]=p.getQuery("secondId",s)||l.data("secondid")||0,n[r]=p.getQuery("mediaId",s)||l.data("mediaid")||"-"}for(var m=0;t>m;m++)a.list["同词条"][m]={shareLemmaId:0,shareLemmaTitle:" ",sourceInfo:!1,playTime:"",title:"--",secondId:o[m],createUid:"",createUname:" ",mediaId:n[m],playUrl:" ",type:"0",secondKind:"1",coverPic:{src:" ",imageUrl:i[m]},extData:!1,playSource:null,playNum:" ",goodNum:0};return a}function r(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],i=window.location.href,o=0,n=0;try{o=i.match(/lemmaId=(\d+)/)[1],n=i.match(/secondId=(\d+)/)[1]}catch(a){}m.q2(e,["secondId="+n,"lemmaId="+o,"from=lemma","isHitFlow="+t.isHitFlow])}var l=function(){function e(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,i,o){return i&&e(t.prototype,i),o&&e(t,o),t}}(),s=function(e,t,i){for(var o=!0;o;){var n=e,a=t,r=i;o=!1,null===n&&(n=Function.prototype);var l=Object.getOwnPropertyDescriptor(n,a);if(void 0!==l){if("value"in l)return l.value;var s=l.get;return void 0===s?void 0:s.call(r)}var d=Object.getPrototypeOf(n);if(null===d)return void 0;e=d,t=a,i=r,o=!0,l=d=void 0}},d=e("wiki-m-common:widget/lib/zepto/zepto"),m=e("wiki-m-common:widget/util/nslog"),c=e("wiki-m-common:widget/component/share/floatShare"),u=e("wiki-m-common:widget/util/checkCss"),h=e("wiki-m-second:widget/videoFlowIn2nd/VideoFlowIn2nd"),w=e("wiki-m-common:widget/component/baikeAppLetter/letter"),p=e("wiki-m-common:widget/util/url"),f=e("wiki-m-second:widget/container/videoCommon/videoCommon"),g=(e("wiki-m-second:widget/component/praise/praise"),e("wiki-m-second:widget/util/guid")),v=e("wiki-m-common:widget/component/sf/sf"),y=e("wiki-m-common:widget/component/swan/swanUtil"),k={lemmaId:d("#J-vars").data("newlemmaid")||(window.location.href.match(/lemmaId=([^&?]+)/)||[])[1]||0,lemmaTitle:d("#J-vars").data("lemmatitle")||window.location.href.split("/")[4],noop:function(){}},b=function(e){function t(){o(this,t),s(Object.getPrototypeOf(t.prototype),"constructor",this).apply(this,arguments)}return n(t,e),l(t,[{key:"constructorInit",value:function(e){this.sf=new v,s(Object.getPrototypeOf(t.prototype),"constructorInit",this).call(this,e),this.logMap.from="lemma",this.emitterClass="J-invoke-2ndvideoflow",this.durationTimer=null;var i=this.sf.$view.find(".rt-body");i.prepend('\n            <div class="lsml-container" id="lsml-container">\n                <div class="bk-common-video-topbar-container"></div>\n                <div class="lemma-secondKnow-medialist second-list-container J-second-list-container"></div>\n            </div>'),this.$2ndContainer=d(".lsml-container"),this.$listContainer=d(".lemma-secondKnow-medialist"),this.$topbarContainer=d(".bk-common-video-topbar-container"),this.lastRenderMediaId="",this.enableSwipe=this.useragentInfo.isMiuiBrowser||this.useragentInfo.isBaiduBox?!0:!1,this.originalPath=window.location.href.substring(window.location.origin.length),this.lemmaShareParam=c.getParam()||{}}},{key:"init",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];k.lemmaId=d("#J-vars").data("newlemmaid")||(window.location.href.match(/lemmaId=([^&?]+)/)||[])[1]||0,k.lemmaTitle=d("#J-vars").data("lemmatitle")||window.location.href.split("/")[4],this.constructorInit(e);var t=this.check2ndElem();if(t){this.initVideoFlow(),this.initPlayer(),this.bindEvents();var i=d("."+this.emitterClass).eq(0).data("playmp4url");this.player.src(i),this.isInApp=e.baikeAppData?!0:!1,this.onShow="function"==typeof e.onShow?e.onShow:k.noop,this.onHide="function"==typeof e.onHide?e.onHide:k.noop}}},{key:"check2ndElem",value:function(){var e=!0,t=d("."+this.emitterClass);0===t.length&&(e=!1,console.log("[_2ndTop Error] there should at least one elem that\n                contains '"+this.emitterClass+"' className to emit the videoFlowLayer"));var i=[];try{i=Array.prototype.map.call(t,function(e){return e.getAttribute("data-mediaid")||0})}catch(o){}var n=i.join(",");return m.qAll("20004801",["lemmaId="+k.lemmaId,"mediaIds="+n]),e}},{key:"initVideoFlow",value:function(){var e=f.topbarTpl,t=f.videoListTpl,i={lemmaTitle:k.lemmaTitle,lemmaId:k.lemmaId,isOverlay:!0,from:"lemma",referrer:document.referrer},o=a(),n=t.fetch(o);if(this.$listContainer.html(n),!y.inSmartprogram){var r=e.fetch(i);this.$topbarContainer.html(r)}}},{key:"fetchData",value:function(e){return new Promise(function(t){d.get(e,function(e){t(e)})})}},{key:"renderVideoFlow",value:function(e){var t=f.videoListTpl,i=t.fetch(e);this.$listContainer.html(i);var o=d(".pgcVideo"),n=o.length;n&&m.q2(this.logMap.pgcVideoPv,["pgcCount="+n]);var a=d(".J-user-link"),r=a.length;if(r){for(var l=[],s=0;r>s;s++){var c=a.eq(s).data("uk");c&&l.push(c)}m.q2(this.logMap.userPv,["userCount="+r,"uks="+l.join(","),"from="+this.logMap.from])}}},{key:"showVideoFlow",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?100:arguments[0];this.displayStatus="show","function"==typeof this.onShow&&this.onShow(),this.lemmaShareParam=c.getParam()||{},this.closeAudio(),this.resetVideoFlow(),this.$2ndContainer.fadeIn(t,function(){window.scrollTo(0,0),e.highlightVideo(e.caculateFocusVideo())}),d("#J-lemma").css("display","none"),d(".rt-body").css("position","static"),this.startDurationRecord(),d(".tashuo-float-view-el").addClass("hide"),this.enterTime=(new Date).getTime(),d(window).off("scroll",this.handleScroll),d(window).on("scroll",this.handleScroll),d("#J-lemma").length?d("#J-lemma").trigger("webViewChange","videoFlow"):d("#app_el").length&&d("#app_el").trigger("webViewChange","videoFlow")}},{key:"hideVideoFlow",value:function(){this.displayStatus="hide","function"==typeof this.onHide&&this.onHide(),this.$2ndContainer.hide(),window.scrollTo(0,0),"function"==typeof window.history.replaceState&&window.history.replaceState({wikisecondJson:null},document.title,this.originalPath),this.stopVideo(),"block"!==d("#J-pre-lemma").css("display")&&d("#J-lemma").css("display","block"),d(".tashuo-float-view-el").removeClass("hide"),c.uploadParam(this.lemmaShareParam);var e=(new Date).getTime()-this.enterTime;m.q2(this.logMap.leavePage,["time="+e,"from=lemma"]),this.stopDurationRecord(),d(window).off("scroll",this.handleScroll),clearTimeout(this.autoplayTimeoutHandler),d("#J-lemma").length?d("#J-lemma").trigger("webViewChange","lemma"):d("#app_el").length&&d("#app_el").trigger("webViewChange","subpage")}},{key:"startDurationRecord",value:function(){var e=this,t=Date.now(),i=g();this.durationTimer=window.setInterval(function(){var o=Date.now(),n=o-t;m.q2(e.logMap.durationTime,["duration="+n,"guid="+i,"from=lemma","type=0"])},5e3)}},{key:"stopDurationRecord",value:function(){this.durationTimer&&clearInterval(this.durationTimer)}},{key:"resetVideoFlow",value:function(){d(".lsml-container").css({transform:"",left:0,top:0})}},{key:"closeAudio",value:function(){"block"===d("#J-audio-control").css("display")&&d("#J-audio-close").trigger("tap"),"block"===d("#J-music-playing").css("display")&&d("#J-music-close").trigger("tap")}},{key:"enableVideoFlowSwipeFunction",value:function(){var e=this,t=document.body.clientWidth,i=0,o=0,n=0,a=0,r=0,l=0,s=40,m=u("transform")?"translateX":"left",c=!1,h=d(".lsml-container");h.on("touchstart",function(e){l=h.offset().left,n=e.touches[0].clientX,a=e.touches[0].clientY}),h.on("touchmove",function(t){/^lark-/.test(t.target.className)||(i=t.touches[0].clientX,o=t.touches[0].clientY,r=i-n-s,c=Math.abs(i-n)>Math.abs(o-a)?!0:!1,c&&t.preventDefault(),c&&r>0&&(e.stopVideo(),h.css("position","absolute"),"translateX"===m?(h.css("transform-origin","0px 0px 0px"),h.css("transform","translateX("+(l+r)+"px)")):h.css("left",l+r+"px")))}),h.on("touchend",function(){if(c){var i=2*t/5;"translateX"===m?d(this).offset().left>i?h.animate({translateX:t+"px"},90,"ease-out",function(){e.hideVideoFlow()}):h.animate({translateX:0},90,"ease-out",function(){h.css("transform","")}):d(this).offset().left>i?h.animate({left:t+"px"},90,"ease-out",function(){e.hideVideoFlow()}):h.animate({left:0},90,"ease-out")}})}},{key:"share",value:function(){var e=this;d("body").on("tap",".J-share",function(){e.stopVideo();var t=d(this),i=t.parents(".J-video"),o=d(".J-video").index(i),n=(i.data("mediaid"),i.data("secondid")),a=t.data("lemmaid"),r=t.data("mediatitle"),l=t.data("pic"),s="https://baike.baidu.com/wikisecond/videoflow?secondId="+n+("&lemmaId="+a);c.uploadParamAndShare({title:r+"-秒懂百科",desc:"秒懂百科：短视频涨知识，世界如此简单。",url:s,pic:l}),m.q2(e.logMap.videoShareClick,["index="+o,"secondId="+n,"from=lemma"])})}},{key:"handleHistory",value:function(){var e=window.location.href;!this.sf.inSf&&/m\.baidu\.com/.test(e)&&this.useragentInfo.isSafari&&window.location.reload(),/wikisecond\/videoflow/.test(e)?this.showVideoFlow(0):"show"===this.displayStatus&&this.hideVideoFlow()}},{key:"pushState",value:function(e){if(e=e.replace(/.*baidu\.com/,""),e&&window.history&&"function"==typeof window.history.pushState){var t=window.location.href;/sf_bk/.test(t)&&(e="/sf_bk"+e),/\&forcehttps=1/.test(t)&&(e+="&forcehttps=1"),e+="&feedInlemma=1",window.history.pushState({feedInLemma:!0},document.title+"_秒懂百科",window.location.origin+e)}}},{key:"set$ElemAttr",value:function(e,t){for(var i in t){var o=i.toLowerCase();e.data(o,t[i])}return e}},{key:"bindEvents",value:function(){var e=this,i=this;window.onpopstate=this.handleHistory.bind(this),this.enableSwipe&&this.enableVideoFlowSwipeFunction(),d("body").on("click","#J-btn-back",function(e){e.preventDefault(),m.q2(i.logMap.goBackBtnClick,["from=lemma"]),i.hideVideoFlow()}),d("body").on("click","#join-us",function(){m.q2(i.logMap.joinUsClick,["from=lemma"])}),d("."+this.emitterClass).on("click",function(){try{var o=d(this),n=o.data("url"),a=o.data("playurl"),l=o.data("playmp4url"),u=p.getQuery("mediaId",n)||o.data("mediaid")||"-",h=p.getQuery("secondId",n)||o.data("secondid")||0,f=p.getQuery("lemmaId",n)||o.data("lemmaid"),g=d(".first-video");if(m.q2("20004802",["lemmaId="+k.lemmaId,"index="+d(this).index(),"count="+d("."+i.emitterClass).length,"mediaId="+u]),i.isInApp)return void w.trigger("secondVideoPlay",[{secondId:h,lemmaId:f}]);if(i.pushState(n),u!==i.lastRenderMediaId){var v={secondId:h,mediaId:u,playUrl:a,playMp4Url:l};i.set$ElemAttr(g,v)}if(i.showVideoFlow(),/^mda-/.test(u)&&i.playVideo(0),u!==i.lastRenderMediaId){i.lastRenderMediaId=u;var y=page.baseUrl+"/wikisecond/mediarank?lemmaId="+f+("&secondId="+h);i.fetchData(y).then(function(o){i.isHitFlow=o.isHitFlow?1:0,i.renderVideoFlow(o),setTimeout(function(){var e=d(".first-video"),t=e.find(".J-share");i._setPlayingSign(e),i.highlightVideo(0),c.uploadParam({title:t.data("mediatitle")+"-秒懂百科",desc:"秒懂百科：短视频涨知识，世界如此简单。",pic:t.data("pic"),url:window.location.href})},50),setTimeout(function(){r(i.logMap.pv,{isHitFlow:i.isHitFlow}),s(Object.getPrototypeOf(t.prototype),"bindEvents",e).call(e)},0)})}else r(i.logMap.pv,{isHitFlow:i.isHitFlow})}catch(b){m.q2("20099901",["errorUrl"+window.location.href,"error"+b.toString()]),window.location.href=d(this).data("url")}})}}]),t}(h);i.exports=b});